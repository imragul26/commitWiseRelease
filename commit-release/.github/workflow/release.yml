name: 📦 Create Release with Commit Messages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.2.3)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 📝 Generate release notes with commits
        id: generate-notes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ github.event.inputs.version }}';
            
            // Get previous release tag
            let previousTag = '1.0.0';
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 10
              });
              
              if (releases.length > 1) {
                previousTag = releases[1].tag_name;
              }
            } catch (error) {
              console.log('Error getting previous releases:', error.message);
            }
            
            // Get all merged PRs since last release
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 30
            });
            
            let releaseNotes = "## What's Changed\n\n";
            let hasChanges = false;
            
            for (const pr of pulls) {
              if (pr.merged_at) {
                // Check if this PR was merged after the previous release
                const mergedAt = new Date(pr.merged_at);
                const isRecent = true; // For simplicity, include all merged PRs
                
                if (isRecent) {
                  hasChanges = true;
                  
                  // Get commits for this PR
                  const { data: commits } = await github.rest.pulls.listCommits({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number
                  });
                  
                  // Add PR title and link
                  releaseNotes += `* **${pr.title}** by @${pr.user.login} in #${pr.number}\n`;
                  
                  // Add commit messages if available
                  if (commits && commits.length > 0) {
                    releaseNotes += "  \n";
                    commits.forEach(commit => {
                      const message = commit.commit.message.split('\n')[0]; // First line only
                      const shaShort = commit.sha.substring(0, 7);
                      releaseNotes += `  • ${shaShort}: ${message}\n`;
                    });
                    releaseNotes += "  \n";
                  }
                }
              }
            }
            
            if (!hasChanges) {
              releaseNotes += "No significant changes.\n\n";
            }
            
            // Add full changelog link
            releaseNotes += `\n**Full Changelog**: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${previousTag}...v${version}\n`;
            
            core.setOutput('release-notes', releaseNotes);
            console.log('Generated release notes with commits');
            
      - name: 🚀 Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Release v${{ github.event.inputs.version }}
          body: ${{ steps.generate-notes.outputs.release-notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
